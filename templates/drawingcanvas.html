<! DOCTYPE html>
<!-- Alex Cherry G00347106 EmerTech drawingcanvas.html file-->

<!-- Reference -> https://bensonruan.com/handwritten-digit-recognition-with-tensorflow-js/-->
<html>
	<head>
	<!-- Styling not used in css file -->
		<style>
			body {
				background-color: white;
			}

			h1 {
				color: navy;
				text-align: center;
			}
			
			p {
				text-align : center;
				font-size : 20px;
			}

			#predict-button {
				background-color: white;
				border: none;
				color: black;
				padding: 15px 32px;
				text-align: center;
				text-decoration: none;
				display: inline-block;
				font-size: 16px;
				border: 2px solid black;
				border-radius: 10px;
				transition-duration: 0.4s;
				
			}

			#predict-button:hover{
				background-color: green;
				color: white;
			}

			#clear-button {
				background-color: white;
				border: none;
				color: black;
				padding: 15px 32px;
				text-align: center;
				text-decoration: none;
				display: inline-block;
				font-size: 16px;
				border: 2px solid black;
				border-radius: 10px;
				transition-duration: 0.4s;
				
			}
			#clear-button:hover{
				background-color: red;
				color: white;
			}

			#prediction-text{
				font-size: 2em;
				text-align: center;
			}
			
			#canvas_box{
				float: center;
				width: 19.7%;
				margin: auto;
				
			}
			.canvas-box{
				border:4px solid red;	
			
			}
			
			.space{
			padding: 0.8%;
			}

		</style>	
	</head>
	
	<!-- JQuery and TensorFlow script imports -->
	<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>

    <body>
	
		<h1>Hand Written Digit Recognition</h1>
		<p> How to use : Simply draw a digit with your mouse left-click and let go when you want
		to finish drawing the digit. </p><p>Only recognises single digits, not double digits or higher.</p>
		<!--<p>The program works by using Keras, TensorFlow, Flask and Python. </p>
		<p>The Model for recognising the digits was made in Jupyter Notebook </p>
		<p>with the Keras and TensorFlow packages. It is then converted to </p>
		<p>Json format with TensorFlow JavaScript converter (tfjs) and read in </p>
		<p>by the Flask app and the Javascript. </p>-->

		<!-- Divs for Canvas and Buttons-->

		<div id="canvas_box" class="canvas-box"></div>
		<div id="extra_space" class ="space"></div>
		<button id="predict-button" class="btn btn-dark" style = "position:relative;  left: 42%">Predict</button>
		<button id="clear-button" style = "position:relative;  left: 43%">Clear</button>
		<div id="text-positioner">
			<p id = "prediction-text" style = "position:relative; ">Number Prediction:  </p>
		</div>

		<!-- Digit Recognition Script -->
		<script src="js/digit-recognition.js"></script>
		
    </body>
	
	<script type="text/javascript">
		let model;
		
		// Width and Height of canvas
		var canvasHeight = 300;
		var canvasWidth = 300;
		
		// Colour of Canvas
		var canvasStrokeStyle = "blue";
		var canvasLineJoin = "round";
		var canvasLineWidth = 10;
		
		// Background of Canvas
		var canvasBackgroundColor = "black";
		var canvasId = "canvas";
		
		var clickX = new Array();
		var clickY = new Array();
		var clickD = new Array();
		var drawing;

		var x = "black";
		
		// Line thickness
		var lineThickness = 3;
		var canvasBox = document.getElementById('canvas_box');
		var canvas = document.createElement("canvas");
		
		canvas.setAttribute("width", canvasWidth);
		canvas.setAttribute("height", canvasHeight);
		canvas.setAttribute("id", canvasId);
		canvas.style.backgroundColor = canvasBackgroundColor;
		canvasBox.appendChild(canvas);

		// checks if browser supports html 
		if(typeof G_vmlCanvasManager != 'undefined') {
			canvas = G_vmlCanvasManager.initElement(canvas);
		}
 
		ctx = canvas.getContext("2d");
			
		// Reference ->https://api.jquery.com/category/events/mouse-events/
		$("#canvas").mousedown(function(e) {
			var rect = canvas.getBoundingClientRect();
			var mouseX = e.clientX- rect.left;;
			var mouseY = e.clientY- rect.top;
			drawing = true;
			addUserGesture(mouseX, mouseY);
			drawOnCanvas();
		});
 
		// touch start, recognising when we start clicking
		// gets the position of where we started clicking
		canvas.addEventListener("touchstart", function (e) {
			if (e.target == canvas) {
				e.preventDefault();
			}
		
			var rect = canvas.getBoundingClientRect();
			var touch = e.touches[0];
		
			var mouseX = touch.clientX - rect.left;
			var mouseY = touch.clientY - rect.top;
		
			drawing = true;
			addUserGesture(mouseX, mouseY);
			drawOnCanvas();
		
		}, false);
 
		// mousemove function
		$("#canvas").mousemove(function(e) {
			if(drawing) {
				var rect = canvas.getBoundingClientRect();
				var mouseX = e.clientX- rect.left;;
				var mouseY = e.clientY- rect.top;
				addUserGesture(mouseX, mouseY, true);
				drawOnCanvas();
			}
		});
		
		
		canvas.addEventListener("touchmove", function (e) {
			if (e.target == canvas) {
				e.preventDefault();
			}
			if(drawing) {
				var rect = canvas.getBoundingClientRect();
				var touch = e.touches[0];
		
				var mouseX = touch.clientX - rect.left;
				var mouseY = touch.clientY - rect.top;
		
				addUserGesture(mouseX, mouseY, true);
				drawOnCanvas();
			}
		}, false);
		

		
		// Touch end function (when mouse lifts off left click)
		canvas.addEventListener("touchend", function (e) {
			if (e.target == canvas) {
				e.preventDefault();
			}
			drawing = false;
		}, false);
		
		// when mouse pointer is released if inside canvas
		$("#canvas").mouseup(function(e) {
			drawing = false;
		});
		
		// touch leave function
		canvas.addEventListener("touchleave", function (e) {
			if (e.target == canvas) {
				e.preventDefault();
			}
			drawing = false;
		}, false);
		
		// if mouse leaves canvas, drawing ends
		$("#canvas").mouseleave(function(e) {
			drawing = false;
		});
		
		// add click function for drawing
		function addUserGesture(x, y, dragging) {
			clickX.push(x);
			clickY.push(y);
			clickD.push(dragging);
		}
		
		// re draw function
		// allows user to let go of left click and left click again (number 4, 7, double digits etc)
		function drawOnCanvas() {
			ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
		
			ctx.strokeStyle = canvasStrokeStyle;
			ctx.lineJoin    = canvasLineJoin;
			ctx.lineWidth   = canvasLineWidth;
		
			for (var i = 0; i < clickX.length; i++) {
				ctx.beginPath();
				if(clickD[i] && i) {
					ctx.moveTo(clickX[i-1], clickY[i-1]);
				} else {
					ctx.moveTo(clickX[i]-1, clickY[i]);
				}
				ctx.lineTo(clickX[i], clickY[i]);
				ctx.closePath();
				ctx.stroke();
			}
		}
		
		// predict button
		$("#predict-button").click(async function () {
			// gets what you've drawn on the image
			console.log("in predict function")
			var imageData = canvas.toDataURL();

			// preprocess the canvas
			let tensor = preprocessCanvas(canvas);
			
			console.log(tensor);
			// make predictions on the preprocessed image tensor
			let predictions = await model.predict(tensor).data();

			console.log(predictions);
		
			// get the model's prediction results
			let results = Array.from(predictions);
		
			displayLabel(results)
			// display the predictions in chart
			console.log(results)
		});
		
		// clear button
		$("#clear-button").click(async function () {
			ctx.clearRect(0, 0, canvasWidth, canvasHeight);
			clickX = new Array();
			clickY = new Array();
			clickD = new Array();
			$(".prediction-text").empty();
			$("#result_box").addClass('d-none');
		
		});
		// load model
		async function loadModel() {
			console.log("in load model function")
			// clear the model variable
			model = undefined; 
			// load the model using a HTTPS request (where you have stored your model files)
			model = await tf.loadLayersModel("static/models/model.json");
		}
 
		loadModel();

		function preprocessCanvas(image) {
			// resize the input image to target size of (1, 28, 28)
			let tensor = tf.browser.fromPixels(image)
				.resizeNearestNeighbor([28, 28])
				.mean(2)
				.expandDims(2)
				.expandDims()
				.toFloat();
			return tensor.div(255.0);
		}

		// display label
		function displayLabel(data) {
			var max = data[0];
			var maxIndex = 0;
		
			for (var i = 1; i < data.length; i++) {
				if (data[i] > max) {
					maxIndex = i;
					max = data[i];
				}
			}

			// our text to display number that has been predicted
			console.log(maxIndex);
			document.getElementById("prediction-text").innerHTML = maxIndex;
		}
	</script>
	
	
</html>
